<ContentDialog
    x:Class="Mechanical_Keyboard.Dialogs.CreateSoundPackDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:Mechanical_Keyboard.Models"
    mc:Ignorable="d"
    x:Name="DialogRoot"
    Title="Create New Sound Pack"
    PrimaryButtonText="Create"
    CloseButtonText="Cancel"
    IsPrimaryButtonEnabled="{x:Bind ViewModel.CanImport, Mode=OneWay}"
    DefaultButton="Primary">

    <ScrollViewer>
        <StackPanel Spacing="16">
            
            <!-- Pack Details Section -->
            <StackPanel Spacing="8">
                <TextBox Header="Sound Pack Name" Text="{x:Bind ViewModel.PackName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                <TextBox Header="Description (Optional)" Text="{x:Bind ViewModel.Description, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                <Grid ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <Image Source="{x:Bind ViewModel.ResolvedIconPath, Mode=OneWay}" 
                           Width="64" Height="64" VerticalAlignment="Bottom"/>

                    <Button Grid.Column="1" 
                            Content="Select Icon" 
                            Command="{x:Bind ViewModel.SelectIconCommand}" 
                            VerticalAlignment="Bottom" 
                            HorizontalAlignment="Left"/>
                </Grid>
            </StackPanel>

            <InfoBar
                Severity="Warning"
                Title="Assignment Required"
                Message="At least one sound must be assigned to 'KeyPress' to create a pack."
                IsOpen="True"
                Opacity="{x:Bind ViewModel.CanImport, Mode=OneWay, Converter={StaticResource InvertedBooleanToOpacityConverter}}"/>

            <!-- File Assignment Section -->
            <ListView ItemsSource="{x:Bind ViewModel.StagedFiles}">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:StagedFile">
                        <Grid ColumnSpacing="12" Padding="0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Text="{x:Bind FileName}" VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                            
                            <!-- This binding is now direct and stable -->
                            <ComboBox Grid.Column="1"
                                      ItemsSource="{x:Bind KeyAssignmentTypes, Mode=OneWay}"
                                      SelectedIndex="{x:Bind AssignmentIndex, Mode=TwoWay}"
                                      MinWidth="150"/>
                        </Grid>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <!-- Options Section -->
            <CheckBox Content="Generate varied pitch sounds from default sounds" 
                      IsChecked="{x:Bind ViewModel.GeneratePitchVariants, Mode=TwoWay}"/>

        </StackPanel>
    </ScrollViewer>
</ContentDialog>
